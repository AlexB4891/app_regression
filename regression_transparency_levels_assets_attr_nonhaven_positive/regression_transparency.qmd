---
title: "Regession analysis report"
format: 
  html:
    number-sections: true
    number-depth: 4
editor: visual
code-fold: false
toc: true
toc-depth: 3
monofontoptions: 
  - Scale=0.35
execute: 
  warning: false
  message: false
params:
  var_dep: "pff_p"
  var_lab: "Tax haven participation"
---

Libraries:

```{r}
library(tidyverse)
library(fixest)
library(broom)
library(scales)
library(here)

source("global.R")

```

```{r}
#| echo: false
model_df_0 <- read_tsv(here(str_c(
    "20231120/params/dep_var_",
    params$var_dep, "_joint.txt"
)))

model_df_0_p <- read_tsv(here(str_c(
    "20231120/performance/dep_var_",
    params$var_dep, "_joint.txt"
)))


```

# Joint groups (T-Maj + T-Min vs C-Maj + C-Min)

## Diff-in-diff design (unsaturated model)

$$Y_{it} = \beta_0 \times Treatment_{i} + \beta_1 \times Post_{t} + \beta_2 \times Treatment_{i} \times Post_{t} + \epsilon_{it}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post')%>% 
  formula(.)

# Model estimation:
did_model <- lm(data = rtable,
                  formula = fml)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model) 

```

## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% 
  filter(model == "Linear model") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear model` = tab_mod))

```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \beta_3 \times Treatment_{i} \times Post_{t} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
-   $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
-   $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post') %>% 
  formula(.)

# Model estimation:
did_model_fe <- plm(data = rtable,
                    formula = fml,
                    index = c("firm_id","anio_fiscal"),
                    model = "within")

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Linear model with fixed effect") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model with fixed effect")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design assets weighted (unsaturated model)

$$Y_{it} = \beta_0 \times Treatment_{i} + \beta_1 \times Post_{t} + \beta_2 \times Treatment_{i} \times Post_{t} + \epsilon_{it}$$ $$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post')%>% 
  formula(.)

# Model estimation:
did_model_aw <- lm(data = rtable,
                   formula = fml,
                   weights = assets_2014)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model) 

```

## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% 
  filter(model == "Linear model assets weighted") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model assets weighted")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear model` = tab_mod))

```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design (Assets weighted): ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design assets weighted (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \beta_3 \times Treatment_{i} \times Post_{t} + \alpha_i + \gamma_t + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
-   $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
-   $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post') %>% 
  formula(.)

# Model estimation:
did_model_fe_aw <- feols(data = rtable,
                         fml = fml_fe,
                         weights = ~assets_2014,
                         cluster = ~firm_id)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Linear model assets weighted with fixed effect") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model assets weighted with fixed effect")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design (Assets weighted): ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```
:::


## Event Study design (unsaturated model)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \epsilon_{it}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model <- lm(data = rtable,
               formula = fml_event_study)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $alpha_i$ are the fixed effects at firm level
-   $gamma_t$ are the fixed effects at time
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model_fe <- plm(data = rtable,
                    formula = fml_event_study,
                    index = c("firm_id","anio_fiscal"),
                    model = "within")

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study with fixed effects") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study with fixed effects")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design assets weighted (unsaturated model)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model_aw <- feols(data = rtable,
                     fml = fml_event_study,
                  weights = ~assets_2014,
                  cluster = ~firm_id)
# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_aw,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study assets weighted") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study assets weighted")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design assets weighted: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design assets weighted (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \alpha_i + \gamma_t + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $alpha_i$ are the fixed effects at firm level
-   $gamma_t$ are the fixed effects at time
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

  fml_event_study_fe <- glue::glue('{dependent} ~  i(anio_fiscal,treatment, ref = 2014) | firm_id + anio_fiscal') %>%
    formula(.)

# Model estimation:
  
es_model_aw_fe <- feols(data = rtable,
                        fml = fml_event_study_fe,
                        weights = ~assets_2014,
                        cluster = ~firm_id)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_aw_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study assets weighted with fixed effects" ) %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study assets weighted with fixed effects" )


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design assets weighted: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::


# Joint groups (T-Maj vs C-Maj)

```{r}
#| echo: false
model_df_0 <- read_tsv(here(str_c(
    "20231120/params/dep_var_",
    params$var_dep, "_majors.txt"
)))

model_df_0_p <- read_tsv(here(str_c(
    "20231120/performance/dep_var_",
    params$var_dep, "_majors.txt"
)))


```

## Diff-in-diff design (unsaturated model)

$$Y_{it} = \beta_0 \times Treatment_{i} + \beta_1 \times Post_{t} + \beta_2 \times Treatment_{i} \times Post_{t} + \epsilon_{it}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post')%>% 
  formula(.)

# Model estimation:
did_model <- lm(data = rtable,
                  formula = fml)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model) 

```

## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% 
  filter(model == "Linear model") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear model` = tab_mod))

```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \beta_3 \times Treatment_{i} \times Post_{t} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
-   $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
-   $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post') %>% 
  formula(.)

# Model estimation:
did_model_fe <- plm(data = rtable,
                    formula = fml,
                    index = c("firm_id","anio_fiscal"),
                    model = "within")

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Linear model with fixed effect") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model with fixed effect")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design assets weighted (unsaturated model)

$$Y_{it} = \beta_0 \times Treatment_{i} + \beta_1 \times Post_{t} + \beta_2 \times Treatment_{i} \times Post_{t} + \epsilon_{it}$$ $$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post')%>% 
  formula(.)

# Model estimation:
did_model_aw <- lm(data = rtable,
                   formula = fml,
                   weights = assets_2014)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model) 

```

## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% 
  filter(model == "Linear model assets weighted") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model assets weighted")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear model` = tab_mod))

```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design (Assets weighted): ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design assets weighted (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \beta_3 \times Treatment_{i} \times Post_{t} + \alpha_i + \gamma_t + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
-   $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
-   $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post') %>% 
  formula(.)

# Model estimation:
did_model_fe_aw <- feols(data = rtable,
                         fml = fml_fe,
                         weights = ~assets_2014,
                         cluster = ~firm_id)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Linear model assets weighted with fixed effect") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model assets weighted with fixed effect")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design (Assets weighted): ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```
:::

## Event Study design (unsaturated model)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \epsilon_{it}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model <- lm(data = rtable,
               formula = fml_event_study)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $alpha_i$ are the fixed effects at firm level
-   $gamma_t$ are the fixed effects at time
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model_fe <- plm(data = rtable,
                    formula = fml_event_study,
                    index = c("firm_id","anio_fiscal"),
                    model = "within")

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study with fixed effects") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study with fixed effects")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design assets weighted (unsaturated model)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model_aw <- feols(data = rtable,
                     fml = fml_event_study,
                  weights = ~assets_2014,
                  cluster = ~firm_id)
# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_aw,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study assets weighted") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study assets weighted")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design assets weighted: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design assets weighted (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \alpha_i + \gamma_t + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $alpha_i$ are the fixed effects at firm level
-   $gamma_t$ are the fixed effects at time
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

  fml_event_study_fe <- glue::glue('{dependent} ~  i(anio_fiscal,treatment, ref = 2014) | firm_id + anio_fiscal') %>%
    formula(.)

# Model estimation:
  
es_model_aw_fe <- feols(data = rtable,
                        fml = fml_event_study_fe,
                        weights = ~assets_2014,
                        cluster = ~firm_id)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_aw_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study assets weighted with fixed effects" ) %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study assets weighted with fixed effects" )


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design assets weighted: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::



# Joint groups (T-Min vs C-Min)

```{r}
#| echo: false
model_df_0 <- read_tsv(here(str_c(
    "20231120/params/dep_var_",
    params$var_dep, "_minors.txt"
)))

model_df_0_p <- read_tsv(here(str_c(
    "20231120/performance/dep_var_",
    params$var_dep, "_minors.txt"
)))


```

## Diff-in-diff design (unsaturated model)

$$Y_{it} = \beta_0 \times Treatment_{i} + \beta_1 \times Post_{t} + \beta_2 \times Treatment_{i} \times Post_{t} + \epsilon_{it}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post')%>% 
  formula(.)

# Model estimation:
did_model <- lm(data = rtable,
                  formula = fml)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model) 

```

## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% 
  filter(model == "Linear model") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear model` = tab_mod))

```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \beta_3 \times Treatment_{i} \times Post_{t} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
-   $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
-   $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post') %>% 
  formula(.)

# Model estimation:
did_model_fe <- plm(data = rtable,
                    formula = fml,
                    index = c("firm_id","anio_fiscal"),
                    model = "within")

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Linear model with fixed effect") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model with fixed effect")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design assets weighted (unsaturated model)

$$Y_{it} = \beta_0 \times Treatment_{i} + \beta_1 \times Post_{t} + \beta_2 \times Treatment_{i} \times Post_{t} + \epsilon_{it}$$ 

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post')%>% 
  formula(.)

# Model estimation:
did_model_aw <- lm(data = rtable,
                   formula = fml,
                   weights = assets_2014)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model) 

```

## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% 
  filter(model == "Linear model assets weighted") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model assets weighted")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear model` = tab_mod))

```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design (Assets weighted): ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "lm")
```
:::

## Diff-in-diff design assets weighted (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \beta_3 \times Treatment_{i} \times Post_{t} + \alpha_i + \gamma_t + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:

-   $Y_{it}$ is `r params$var_lab`, the dependent variable for unit $i$ at time $t$.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Post_{t}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
-   $Treatment_{i} \times Post_{t}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
-   $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
-   $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml <- glue::glue('dependent_variable ~ treatment + post + treatment:post') %>% 
  formula(.)

# Model estimation:
did_model_fe_aw <- feols(data = rtable,
                         fml = fml_fe,
                         weights = ~assets_2014,
                         cluster = ~firm_id)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = did_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Linear model assets weighted with fixed effect") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Linear model assets weighted with fixed effect")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design (Assets weighted): ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```
:::

## Event Study design (unsaturated model)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \epsilon_{it}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model <- lm(data = rtable,
               formula = fml_event_study)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $alpha_i$ are the fixed effects at firm level
-   $gamma_t$ are the fixed effects at time
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model_fe <- plm(data = rtable,
                    formula = fml_event_study,
                    index = c("firm_id","anio_fiscal"),
                    model = "within")

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study with fixed effects") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study with fixed effects")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design assets weighted (unsaturated model)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:
-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

fml_event_study <- glue::glue('{dependent} ~  anio_fiscal + treatment + i(anio_fiscal,treatment, ref = 2014)') %>%
    formula(.)

# Model estimation:
es_model_aw <- feols(data = rtable,
                     fml = fml_event_study,
                  weights = ~assets_2014,
                  cluster = ~firm_id)
# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_aw,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study assets weighted") %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study assets weighted")


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design assets weighted: ",params$var_lab),
               subtitle_plot  = "Unsaturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design assets weighted (with fixed effects)

$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{i} + \beta_2 \times Post_{t} + \sum_{k \neq 2014} \beta_k \times Time_{k} \times Treatment_{i} + \alpha_i + \gamma_t + \epsilon_{it}$$

$$\text{Note: The model is weighted by: Total assets 2014.}$$

Where:
-   $\{ k = 2012, \ldots, 2017 \}$
-   $Y_{it}$ is `r params$var_lab`, the dependent variable.
-   $Treatment_{i}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
-   $Time_{i}$ are dummy variables that are 1 if the year is $k$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
-   $alpha_i$ are the fixed effects at firm level
-   $gamma_t$ are the fixed effects at time
-   $\epsilon_{it}$ is the error term.

**Dependent variable:** `r params$var_lab`

::: panel-tabset
## R Code

```{r, eval=FALSE}

# With this code we construct our formula as a string to use in the model function.
# Check above to see the label of the dependent variable.

  fml_event_study_fe <- glue::glue('{dependent} ~  i(anio_fiscal,treatment, ref = 2014) | firm_id + anio_fiscal') %>%
    formula(.)

# Model estimation:
  
es_model_aw_fe <- feols(data = rtable,
                        fml = fml_event_study_fe,
                        weights = ~assets_2014,
                        cluster = ~firm_id)

# Wald test using clustered matrix of variance/covariance:
vcov_cl <- vcovCL(x = es_model_aw_fe,
                  cluster = rtable$firm_id)

# Adjusted standard errors:
model_corrected <- coeftest(vcov. = vcov_cl,
                            x = did_model_fe) 

```

## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% 
  filter(model == "Event study assets weighted with fixed effects" ) %>% 
  mutate(term = str_remove_all(term,"^treatment|^post"),
         term = str_replace(term,":post",":"))

model_df_p <- model_df_0_p %>% 
  filter(model == "Event study assets weighted with fixed effects" )


tab_mod <- extract_broom(tidy_model = model_df,
                         glance_model = model_df_p)  

screenreg(list(`Linear modelwith fixed effect` = tab_mod))
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event Study Design assets weighted: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::