---
title: "Regession analysis report"
format: 
  html:
    number-sections: true
    number-depth: 4
editor: visual
code-fold: false
monofontoptions: 
  - Scale=0.35
execute: 
  warning: false
  message: false
params:
  var_dep: "pff_p"
  var_lab: "Tax haven participation"
---

# Environment:

R version:

```{r}
R.version
```

Libraries:

```{r}
library(tidyverse)
library(fixest)
library(broom)
library(scales)
library(here)

source("global.R")


choices_grupo <- c("T-Maj + T-Min vs C-Maj + C-Min" = "joint",
                   "T-Maj vs C-Maj" = "majors",
                   "T-Min vs C-Min" = "minors")

choices_variable <- c("Tax haven participation" = "pff_p",
                      "Foreign participation" = "ext_p",
                      "Log amount of assets attributable to TH" = "log_assets_attr_pff",
                      "Log amount of assets attributable to non TH" = "log_assets_attr_ext",
                      "Log(CIT liability)" = "log_cit_liability",
                      "Log(Profits)"  = "log_utility",
                      "Log(Taxable profits)" = "log_taxable_profits",
                      "Prominent participation in group" = "prominent",
                      "Amount of assets atributables in dominant group"  = "log_assets_prominent")

choices_model <- c("Saturarated model" = "satu",
                   "Fixed effect model" = "fe")

choices_design <- c("Diff-in-diff design" = "lm",
                    "Event study design"  = "es")

```

# Preamble

```{r}
model_df_0 <- read_tsv(here(str_c("20231024/params/dep_var_",
                           params$var_dep,"_joint.txt")))

model_df_0_p <- read_tsv(here(str_c("20231024/performance/dep_var_",
                           params$var_dep,"_joint.txt")))


```


# Joint groups (T-Maj + T-Min vs C-Maj + C-Min)

## Diff-in-diff design (Saturated model)


$$Y_{it} = \beta_0 \times Treatment_{it} + \beta_1 \times Post_{it} + \beta_2 \times Treatment_{it} \times Post_{it} + \epsilon$$
Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Treatment_{it}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
- $Post_{it}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
- $Treatment_{it} \times Post_{it}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.



::: {.panel-tabset}

## R Code

```{r, eval=FALSE}

fml <- glue::glue('{dependent} ~ treatment + post + treatment:post')

model <- lm(data = rtable,
            formula = fml)

# Wald test using clustered matrix of variance/covariance:

vcov_cl <- vcovCL(x = model,
                  cluster = rtable$firm_id)

model_corrected <- coeftest(vcov. = vcov_cl,
                            x = model) 


```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Linear model")

model_df_p <- model_df_0_p %>% filter(model == "Linear model")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```

:::

## Diff-in-diff design (with fixed effects)


$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{it} + \beta_2 \times Post_{it} + \beta_3 \times Treatment_{it} \times Post_{it} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Treatment_{it}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
- $Post_{it}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
- $Treatment_{it} \times Post_{it}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
- $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
- $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
- $\epsilon_{it}$ is the error term.



::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


model_fe <- plm(data = rtable,
                formula = fml,
                index = c("firm_id","anio_fiscal"),
                model = "within")

# Wald test using clustered matrix of variance/covariance:

vcov_hc <- vcovHC(x = model_fe,
                  type = "HC1",
                  cluster = "group")

model_corrected_fe <- coeftest(vcov. = vcov_hc,
                               x = model_fe) 


```


## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% filter(model == "Linear model with fixed effect")

model_df_p <- model_df_0_p %>% filter(model == "Linear model with fixed effect")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```

:::


## Event Study design (saturated model)


$$Y_{it} = \beta_0 + \sum_{i \neq 2014} \beta_i \times Time_{i} + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable.
- $Time_{i}$ are dummy variables that are 1 if the year is $i$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
- $\beta_0$ is the intercept.
- $\beta_i$ are the coefficients of the dummy variables for the years, which capture the effect of the year change on the dependent variable.
- $\epsilon_{it}$ is the error term.


::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


  es_fml <- glue::glue('{dependent} ~ anio_refact') %>% 
    formula(.)
  # browser()
  
  model_es <- lm(data = rtable_time,
                      formula = es_fml)
  
  vcov_cl <- vcovCL(x = model_es,
                      cluster = rtable$firm_id)




```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Event study saturated")

model_df_p <- model_df_0_p %>% filter(model == "Event study saturated")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event study design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design (fixed effects model)


$$Y_{it} = \beta_0 + \sum_{i \neq 2014} \beta_i \times Time_{i} + \alpha_i + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Time_{i}$ are dummy variables that are 1 if the year is $i$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
- $\beta_0$ is the intercept.
- $\beta_i$ are the coefficients of the dummy variables for the years, which capture the effect of the year change on the dependent variable.
- $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
- $\epsilon_{it}$ is the error term.


::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


  es_fml <- glue::glue('{dependent} ~ anio_refact') %>% 
    formula(.)
  # browser()
  
  model_es_fe <- plm(data = rtable_time,
                     formula = es_fml,
                     index = c("firm_id","anio_fiscal"), 
                     model = "within")

# Wald test using clustered matrix of variance/covariance:

vcov_cl <- vcovHC(x = model_es_fe,
                      type = "HC1", 
                      cluster = "group")

model_corrected_fe <- coeftest(vcov. = vcov_hc,
                               x = model_fe) 


```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Event study saturated with fixed effects"  )

model_df_p <- model_df_0_p %>% filter(model == "Event study saturated with fixed effects"  )


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event study design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::

# Major groups (T-Maj vs C-Maj)


```{r}
model_df_0 <- read_tsv(here(str_c("20231024/params/dep_var_",
                           params$var_dep,"_majors.txt")))

model_df_0_p <- read_tsv(here(str_c("20231024/performance/dep_var_",
                           params$var_dep,"_majors.txt")))


```

## Diff-in-diff design (Saturated model)


$$Y_{it} = \beta_0 \times Treatment_{it} + \beta_1 \times Post_{it} + \beta_2 \times Treatment_{it} \times Post_{it} + \epsilon$$
Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Treatment_{it}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
- $Post_{it}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
- $Treatment_{it} \times Post_{it}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.



::: {.panel-tabset}

## R Code

```{r, eval=FALSE}

fml <- glue::glue('{dependent} ~ treatment + post + treatment:post')

model <- lm(data = rtable,
            formula = fml)

# Wald test using clustered matrix of variance/covariance:

vcov_cl <- vcovCL(x = model,
                  cluster = rtable$firm_id)

model_corrected <- coeftest(vcov. = vcov_cl,
                            x = model) 


```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Linear model")

model_df_p <- model_df_0_p %>% filter(model == "Linear model")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```

:::

## Diff-in-diff design (with fixed effects)


$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{it} + \beta_2 \times Post_{it} + \beta_3 \times Treatment_{it} \times Post_{it} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Treatment_{it}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
- $Post_{it}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
- $Treatment_{it} \times Post_{it}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
- $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
- $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
- $\epsilon_{it}$ is the error term.



::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


model_fe <- plm(data = rtable,
                formula = fml,
                index = c("firm_id","anio_fiscal"),
                model = "within")

# Wald test using clustered matrix of variance/covariance:

vcov_hc <- vcovHC(x = model_fe,
                  type = "HC1",
                  cluster = "group")

model_corrected_fe <- coeftest(vcov. = vcov_hc,
                               x = model_fe) 


```


## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% filter(model == "Linear model with fixed effect")

model_df_p <- model_df_0_p %>% filter(model == "Linear model with fixed effect")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```

:::


## Event Study design (saturated model)


$$Y_{it} = \beta_0 + \sum_{i \neq 2014} \beta_i \times Time_{i} + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable.
- $Time_{i}$ are dummy variables that are 1 if the year is $i$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
- $\beta_0$ is the intercept.
- $\beta_i$ are the coefficients of the dummy variables for the years, which capture the effect of the year change on the dependent variable.
- $\epsilon_{it}$ is the error term.


::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


  es_fml <- glue::glue('{dependent} ~ anio_refact') %>% 
    formula(.)
  # browser()
  
  model_es <- lm(data = rtable_time,
                      formula = es_fml)
  
  vcov_cl <- vcovCL(x = model_es,
                      cluster = rtable$firm_id)




```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Event study saturated")

model_df_p <- model_df_0_p %>% filter(model == "Event study saturated")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event study design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design (fixed effects model)


$$Y_{it} = \beta_0 + \sum_{i \neq 2014} \beta_i \times Time_{i} + \alpha_i + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Time_{i}$ are dummy variables that are 1 if the year is $i$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
- $\beta_0$ is the intercept.
- $\beta_i$ are the coefficients of the dummy variables for the years, which capture the effect of the year change on the dependent variable.
- $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
- $\epsilon_{it}$ is the error term.


::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


  es_fml <- glue::glue('{dependent} ~ anio_refact') %>% 
    formula(.)
  # browser()
  
  model_es_fe <- plm(data = rtable_time,
                     formula = es_fml,
                     index = c("firm_id","anio_fiscal"), 
                     model = "within")

# Wald test using clustered matrix of variance/covariance:

vcov_cl <- vcovHC(x = model_es_fe,
                      type = "HC1", 
                      cluster = "group")

model_corrected_fe <- coeftest(vcov. = vcov_hc,
                               x = model_fe) 


```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Event study saturated with fixed effects"  )

model_df_p <- model_df_0_p %>% filter(model == "Event study saturated with fixed effects"  )

extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event study design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::

# Minor groups (T-Min vs C-Min)


```{r}
model_df_0 <- read_tsv(here(str_c("20231024/params/dep_var_",
                           params$var_dep,"_minors.txt")))

model_df_0_p <- read_tsv(here(str_c("20231024/performance/dep_var_",
                           params$var_dep,"_minors.txt")))


```

## Diff-in-diff design (Saturated model)


$$Y_{it} = \beta_0 \times Treatment_{it} + \beta_1 \times Post_{it} + \beta_2 \times Treatment_{it} \times Post_{it} + \epsilon$$
Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Treatment_{it}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
- $Post_{it}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
- $Treatment_{it} \times Post_{it}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.



::: {.panel-tabset}

## R Code

```{r, eval=FALSE}

fml <- glue::glue('{dependent} ~ treatment + post + treatment:post')

model <- lm(data = rtable,
            formula = fml)

# Wald test using clustered matrix of variance/covariance:

vcov_cl <- vcovCL(x = model,
                  cluster = rtable$firm_id)

model_corrected <- coeftest(vcov. = vcov_cl,
                            x = model) 


```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Linear model")

model_df_p <- model_df_0_p %>% filter(model == "Linear model")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot

```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "lm")
```

:::

## Diff-in-diff design (with fixed effects)


$$Y_{it} = \beta_0 + \beta_1 \times Treatment_{it} + \beta_2 \times Post_{it} + \beta_3 \times Treatment_{it} \times Post_{it} + \alpha_i + \gamma_t + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Treatment_{it}$ is a dummy variable that is 1 if unit $i$ receives the treatment at time $t$, and 0 otherwise.
- $Post_{it}$ is a dummy variable that is 1 if time $t$ is after the implementation of the treatment, and 0 otherwise.
- $Treatment_{it} \times Post_{it}$ is the interaction between the treatment and the post period, which captures the treatment effect in the difference-in-differences.
- $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
- $\gamma_t$ is the fixed effect for time $t$, which captures any time shock that affects all units in the same way.
- $\epsilon_{it}$ is the error term.



::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


model_fe <- plm(data = rtable,
                formula = fml,
                index = c("firm_id","anio_fiscal"),
                model = "within")

# Wald test using clustered matrix of variance/covariance:

vcov_hc <- vcovHC(x = model_fe,
                  type = "HC1",
                  cluster = "group")

model_corrected_fe <- coeftest(vcov. = vcov_hc,
                               x = model_fe) 


```


## Regression table

```{r, echo=FALSE}

model_df <- model_df_0 %>% filter(model == "Linear model with fixed effect")

model_df_p <- model_df_0_p %>% filter(model == "Linear model with fixed effect")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Diff-in-Diff Design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "lm")
```

:::


## Event Study design (saturated model)


$$Y_{it} = \beta_0 + \sum_{i \neq 2014} \beta_i \times Time_{i} + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable.
- $Time_{i}$ are dummy variables that are 1 if the year is $i$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
- $\beta_0$ is the intercept.
- $\beta_i$ are the coefficients of the dummy variables for the years, which capture the effect of the year change on the dependent variable.
- $\epsilon_{it}$ is the error term.


::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


  es_fml <- glue::glue('{dependent} ~ anio_refact') %>% 
    formula(.)
  # browser()
  
  model_es <- lm(data = rtable_time,
                      formula = es_fml)
  
  vcov_cl <- vcovCL(x = model_es,
                      cluster = rtable$firm_id)




```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Event study saturated")

model_df_p <- model_df_0_p %>% filter(model == "Event study saturated")


extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event study design: ",params$var_lab),
               subtitle_plot  = "Saturated model with firm clustered standard errors",
               type = "es")
```

:::

## Event Study design (fixed effects model)


$$Y_{it} = \beta_0 + \sum_{i \neq 2014} \beta_i \times Time_{i} + \alpha_i + \epsilon_{it}$$

Where:

- $Y_{it}$ is the dependent variable for unit $i$ at time $t$.
- $Time_{i}$ are dummy variables that are 1 if the year is $i$, and 0 otherwise. The year 2014 is the reference year and therefore does not appear in the equation.
- $\beta_0$ is the intercept.
- $\beta_i$ are the coefficients of the dummy variables for the years, which capture the effect of the year change on the dependent variable.
- $\alpha_i$ is the fixed effect for unit $i$, which captures time-invariant characteristics of each unit.
- $\epsilon_{it}$ is the error term.


::: {.panel-tabset}

## R Code

```{r, eval=FALSE}


  es_fml <- glue::glue('{dependent} ~ anio_refact') %>% 
    formula(.)
  # browser()
  
  model_es_fe <- plm(data = rtable_time,
                     formula = es_fml,
                     index = c("firm_id","anio_fiscal"), 
                     model = "within")

# Wald test using clustered matrix of variance/covariance:

vcov_cl <- vcovHC(x = model_es_fe,
                      type = "HC1", 
                      cluster = "group")

model_corrected_fe <- coeftest(vcov. = vcov_hc,
                               x = model_fe) 


```


## Regression table

```{r, echo=FALSE}


model_df <- model_df_0 %>% filter(model == "Event study saturated with fixed effects"  )

model_df_p <- model_df_0_p %>% filter(model == "Event study saturated with fixed effects"  )



extract_broom(tidy_model = model_df,glance_model = model_df_p) %>% 
  screenreg()
```

## Plot



```{r, echo=FALSE}
coef_plot_plus(model_df,
               title_plot  = str_c("Event study design: ",params$var_lab),
               subtitle_plot  = "Fixed effects model with firm clustered standard errors",
               type = "es")
```

:::